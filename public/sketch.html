<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>p5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.3.1/p5.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.3.1/addons/p5.sound.min.js"></script> -->
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <script>
      // iframeからのメッセージをリッスンする
      window.addEventListener('message', (event) => {
        // console.log(event.data);
        // console.log('in p5.js message event listener');

        const _fragCode = event.data;
        const _shader = createShader(vertCode, _fragCode);
        shader(_shader);
        // todo
        // shaderのコンパイルエラー取得
        //
        myShaders.push(_shader);
      });

      // let myShader;
      let myShaders = [];

      const vertCode = `
        precision highp float;
        // p5.jsのデフォルトの頂点位置属性
        attribute vec3 aPosition;
        void main() {
          gl_Position = vec4(aPosition, 1.0);
        }
      `;
      const fragCode = `
        precision highp float;
        uniform float u_time;
        void main() {
          vec3 color = vec3(sin(u_time) * 0.5 + 0.5, 0, 0);
          gl_FragColor = vec4(color, 1.0);
        }
      `;
      const fragCode2 = `
        precision highp float;
        uniform float u_time;
        void main() {
          vec3 color = vec3(0, sin(u_time) * 0.5 + 0.5, 0);
          gl_FragColor = vec4(color, 1.0);
        }
      `;

      function setup() {
        createCanvas(windowWidth, windowHeight, WEBGL);

        let tempShader = createShader(vertCode, fragCode);
        shader(tempShader);

        // shaderコンパイルエラー取得
        //

        myShaders.push(tempShader);

        tempShader = createShader(vertCode, fragCode2);
        shader(tempShader);
        myShaders.push(tempShader);
        tempShader = createShader(vertCode, fragCode);
        shader(tempShader);
        myShaders.push(tempShader);
      }

      function draw() {
        background(220);

        // translate(-width / 2, -height / 2);
        noStroke();
        if (myShaders.length == 0) return;

        const rangeLength = 2; // 1から-1までの長さ
        const interval = rangeLength / myShaders.length; // 間隔
        for (let i = 0; i < myShaders.length; i++) {
          myShaders[i].setUniform('u_time', millis() / 1000.0);

          shader(myShaders[i]);
          console.log(1 - interval * i);
          quad(
            -1,
            -(1 - interval * i),
            -1,
            -(1 - interval * i) + interval,
            1,
            -(1 - interval * i) + interval,
            1,
            -(1 - interval * i)
          );
          // resetShader();
        }
        resetShader();
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </body>
</html>
